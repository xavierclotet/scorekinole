rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Helper function to check if user is the owner/participant of the match
    function isMatchParticipant(matchData) {
      return matchData.savedBy.userId == request.auth.uid ||
             (matchData.players.team1.userId != null && matchData.players.team1.userId == request.auth.uid) ||
             (matchData.players.team2.userId != null && matchData.players.team2.userId == request.auth.uid);
    }

    match /matches/{matchId} {
      // Allow create if authenticated and user is the one creating it
      allow create: if isAuthenticated() &&
                      request.resource.data.savedBy.userId == request.auth.uid;

      // Allow read if authenticated and user is a participant OR admin
      allow read: if isAuthenticated() && (
        isMatchParticipant(resource.data) || isAdmin()
      );

      // Allow update/delete if authenticated and user is the owner (savedBy) OR admin
      allow update, delete: if isAuthenticated() && (
        resource.data.savedBy.userId == request.auth.uid || isAdmin()
      );
    }

    // User profiles
    match /users/{userId} {
      // Users can read/write their own profile
      // Admins can read/write any profile
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin()
      );
      allow write: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin()
      );
    }

    // Current match per user - users can only access their own
    match /currentMatch/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Tournaments - key-based access control
    match /tournaments/{tournamentId} {
      // Only admins can create tournaments
      allow create: if isAdmin();

      // Anyone can read tournaments (key acts as access control)
      // This allows non-authenticated users to join with tournament key
      allow read: if true;

      // Anyone can update tournaments (key acts as access control)
      // This allows non-authenticated users to update match status/results
      // Security note: The 6-character key provides access control
      allow update: if true;

      // Only admins can delete tournaments
      allow delete: if isAdmin();
    }

    // Match invitations for friendly matches
    // Allows registered users to invite others via QR code/link
    match /matchInvites/{inviteId} {
      // Anyone can read invites (to validate invite codes)
      allow read: if true;

      // Authenticated users can create invites (must be the host)
      allow create: if isAuthenticated() &&
        request.resource.data.hostUserId == request.auth.uid;

      // Host can update/cancel, or guest can accept pending invites
      allow update: if isAuthenticated() && (
        resource.data.hostUserId == request.auth.uid ||
        (resource.data.status == 'pending' &&
         request.resource.data.status == 'accepted' &&
         request.resource.data.guestUserId == request.auth.uid)
      );

      // Host can delete their own invites
      allow delete: if isAuthenticated() &&
        resource.data.hostUserId == request.auth.uid;
    }

    // Venues collection - for tournament locations
    match /venues/{venueId} {
      // Admins can read venues (query filters by ownerId in code)
      // Note: Firestore can't enforce ownerId filter in rules for queries,
      // so we allow read for all admins and filter in the query itself
      allow read: if isAdmin();

      // Admins can create venues for themselves
      allow create: if isAdmin() && request.resource.data.ownerId == request.auth.uid;

      // Admins can update/delete only their own venues
      allow update, delete: if isAdmin() && resource.data.ownerId == request.auth.uid;
    }

    // Settings collection - for global app configuration
    match /settings/{settingId} {
      // Anyone authenticated can read settings
      allow read: if isAuthenticated();

      // Only super admins can write settings
      allow write: if isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
